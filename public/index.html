<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chopin - Corgi AI Research Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .loading-dots::after {
      content: '';
      animation: dots 1.5s infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <!-- Header -->
  <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-3xl">ğŸ•</span>
        <div>
          <h1 class="text-xl font-bold text-white">Chopin</h1>
          <p class="text-sm text-gray-400">Research Agent for <a href="https://corgi.insure" target="_blank" class="text-orange-400 hover:underline">Corgi AI</a></p>
        </div>
      </div>
      <div id="apiStatus" class="flex gap-2 text-xs">
        <!-- API status badges will be inserted here -->
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <!-- Use Case Banner -->
    <div class="bg-gradient-to-r from-orange-600 to-orange-500 rounded-lg p-6 mb-8 text-white">
      <div class="flex items-center gap-4">
        <div class="text-4xl">ğŸ›¡ï¸</div>
        <div>
          <h2 class="text-xl font-bold">Corgi AI - Startup Insurance</h2>
          <p class="text-orange-100">Research target startups and generate personalized insurance sales outreach</p>
        </div>
      </div>
    </div>

    <!-- Pipeline Visualization -->
    <div class="bg-gray-800 rounded-lg p-6 mb-8 border border-gray-700">
      <h2 class="text-sm font-semibold text-gray-400 uppercase mb-4">Pipeline</h2>
      <div class="flex items-center justify-center gap-4 flex-wrap">
        <div id="step-agentql" class="flex items-center gap-2 px-4 py-2 bg-gray-700 rounded-lg transition-all">
          <span class="text-lg">ğŸ”</span>
          <div>
            <div class="font-medium text-sm">AgentQL</div>
            <div class="text-xs text-gray-400">Web Scraping</div>
          </div>
        </div>
        <span class="text-gray-500">â†’</span>
        <div id="step-yutori" class="flex items-center gap-2 px-4 py-2 bg-gray-700 rounded-lg transition-all">
          <span class="text-lg">ğŸ§ </span>
          <div>
            <div class="font-medium text-sm">Yutori</div>
            <div class="text-xs text-gray-400">Deep Research</div>
          </div>
        </div>
        <span class="text-gray-500">â†’</span>
        <div id="step-freepik" class="flex items-center gap-2 px-4 py-2 bg-gray-700 rounded-lg transition-all">
          <span class="text-lg">ğŸ¨</span>
          <div>
            <div class="font-medium text-sm">Freepik</div>
            <div class="text-xs text-gray-400">Hero Image</div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column - Input -->
      <div class="lg:col-span-1">
        <!-- Research Form -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-6">
          <h2 class="text-sm font-semibold text-gray-400 uppercase mb-4">ğŸ¯ Research a Startup</h2>
          <p class="text-gray-400 text-sm mb-4">Enter any startup to generate a personalized Corgi AI insurance pitch.</p>
          <form id="researchForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Company Name *</label>
              <input type="text" id="companyName" placeholder="e.g., Notion, Figma, Linear"
                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Company Domain</label>
              <input type="text" id="companyDomain" placeholder="e.g., notion.so, figma.com"
                class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500">
              <p class="text-xs text-gray-500 mt-1">Optional - will be inferred from name</p>
            </div>
            <button type="submit" id="submitBtn"
              class="w-full py-3 px-4 bg-orange-600 hover:bg-orange-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
              <span>ğŸ”¬</span>
              <span>Generate Insurance Brief</span>
            </button>
          </form>
        </div>

        <!-- Quick Examples -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 mb-6">
          <h2 class="text-sm font-semibold text-gray-400 uppercase mb-4">ğŸ’¡ Quick Examples</h2>
          <p class="text-xs text-gray-500 mb-3">Click to populate</p>
          <div class="flex flex-wrap gap-2">
            <button onclick="setExample('Notion', 'notion.so')" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">Notion</button>
            <button onclick="setExample('Figma', 'figma.com')" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">Figma</button>
            <button onclick="setExample('Linear', 'linear.app')" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">Linear</button>
            <button onclick="setExample('Vercel', 'vercel.com')" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">Vercel</button>
            <button onclick="setExample('Retool', 'retool.com')" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">Retool</button>
            <button onclick="setExample('Stripe', 'stripe.com')" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">Stripe</button>
          </div>
        </div>

        <!-- Saved Results -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h2 class="text-sm font-semibold text-gray-400 uppercase mb-4">ğŸ“ Recent Research</h2>
          <div id="savedResults" class="space-y-2 max-h-64 overflow-y-auto">
            <!-- Will be populated by JS -->
          </div>
        </div>
      </div>

      <!-- Right Column - Results -->
      <div class="lg:col-span-2">
        <div id="resultsPanel" class="bg-gray-800 rounded-lg border border-gray-700 min-h-[600px]">
          <!-- Initial State -->
          <div id="initialState" class="flex flex-col items-center justify-center h-[600px] text-gray-500">
            <span class="text-6xl mb-4">ğŸ•</span>
            <p class="text-lg font-medium text-gray-300">Ready to research</p>
            <p class="text-sm mt-2 text-center max-w-md">Enter any startup company to generate a personalized Corgi AI insurance sales brief with pain points, hooks, and outreach templates.</p>
            <div class="mt-6 px-4 py-2 bg-gray-700 rounded-lg text-sm">
              â±ï¸ Research takes 3-5 minutes per company
            </div>
          </div>

          <!-- Loading State -->
          <div id="loadingState" class="hidden flex-col items-center justify-center h-[600px]">
            <div class="animate-spin text-6xl mb-4">â³</div>
            <p class="text-lg font-medium text-white">Researching<span class="loading-dots"></span></p>
            <p id="loadingStatus" class="text-sm text-gray-400 mt-2">Starting pipeline...</p>
            <div class="mt-6 w-64 bg-gray-700 rounded-full h-2">
              <div id="progressBar" class="bg-orange-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-4">This takes 3-5 minutes - please wait</p>
          </div>

          <!-- Results State -->
          <div id="resultsState" class="hidden p-6">
            <!-- Will be populated by JS -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-700 mt-12 py-6">
    <div class="max-w-6xl mx-auto px-4 text-center text-sm text-gray-500">
      Built for <a href="https://corgi.insure" target="_blank" class="text-orange-400 hover:underline">Corgi AI</a> â€¢ 
      Agentic Orchestration Hackathon 2025 â€¢ 
      <a href="https://github.com/mitchell-reynolds/chopin" target="_blank" class="text-blue-400 hover:underline">GitHub</a>
    </div>
  </footer>

  <script>
    // API Base URL
    const API_BASE = window.location.origin;
    
    // DOM Elements
    const apiStatus = document.getElementById('apiStatus');
    const savedResults = document.getElementById('savedResults');
    const researchForm = document.getElementById('researchForm');
    const companyName = document.getElementById('companyName');
    const companyDomain = document.getElementById('companyDomain');
    const submitBtn = document.getElementById('submitBtn');
    const initialState = document.getElementById('initialState');
    const loadingState = document.getElementById('loadingState');
    const resultsState = document.getElementById('resultsState');
    const loadingStatus = document.getElementById('loadingStatus');
    const progressBar = document.getElementById('progressBar');

    // Pipeline steps
    const pipelineSteps = ['agentql', 'yutori', 'freepik'];

    // Initialize
    async function init() {
      await checkHealth();
      await loadSavedResults();
    }

    // Check API health
    async function checkHealth() {
      try {
        const res = await fetch(`${API_BASE}/health`);
        const data = await res.json();
        
        const apis = [
          { name: 'AgentQL', key: 'agentql', enabled: data.apis.agentql },
          { name: 'Yutori', key: 'yutori', enabled: data.apis.yutori },
          { name: 'Freepik', key: 'freepik', enabled: data.apis.freepik }
        ];
        
        apiStatus.innerHTML = apis.map(api => `
          <span class="px-2 py-1 rounded ${api.enabled ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}">
            ${api.name} ${api.enabled ? 'âœ“' : 'âœ—'}
          </span>
        `).join('');
      } catch (e) {
        apiStatus.innerHTML = '<span class="px-2 py-1 rounded bg-red-900 text-red-300">Server Offline</span>';
      }
    }

    // Load saved results
    async function loadSavedResults() {
      try {
        const res = await fetch(`${API_BASE}/results`);
        const data = await res.json();
        
        if (data.count === 0) {
          savedResults.innerHTML = '<p class="text-gray-500 text-sm">No research history yet</p>';
          return;
        }
        
        savedResults.innerHTML = data.results.slice(0, 10).map(r => {
          // Extract company name from filename
          const name = r.filename.replace(/-run-\d+\.json$/, '').replace(/-/g, ' ');
          const capitalizedName = name.charAt(0).toUpperCase() + name.slice(1);
          return `
            <button onclick="loadResult('${r.filename}')"
              class="w-full text-left px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
              <div class="font-medium text-sm">${capitalizedName}</div>
              <div class="text-xs text-gray-500">${new Date(r.created).toLocaleDateString()}</div>
            </button>
          `;
        }).join('');
      } catch (e) {
        savedResults.innerHTML = '<p class="text-gray-500 text-sm">Could not load history</p>';
      }
    }

    // Set example
    function setExample(name, domain) {
      companyName.value = name;
      companyDomain.value = domain;
    }

    // Load a saved result
    async function loadResult(filename) {
      try {
        const res = await fetch(`${API_BASE}/results/${filename}`);
        const data = await res.json();
        displayResults(data);
      } catch (e) {
        alert('Could not load result');
      }
    }

    // Submit research form
    researchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = companyName.value.trim();
      const domain = companyDomain.value.trim();
      
      if (!name) {
        alert('Please enter a company name');
        return;
      }
      
      await generateResearch(name, domain);
    });

    // Generate research
    async function generateResearch(name, domain) {
      // Show loading state
      showState('loading');
      submitBtn.disabled = true;
      resetPipeline();
      
      // Simulate pipeline progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 1;
        progressBar.style.width = `${Math.min(progress, 95)}%`;
        
        if (progress < 20) {
          updatePipelineStep('agentql', 'active');
          loadingStatus.textContent = `AgentQL: Scraping ${name}'s website...`;
        } else if (progress < 85) {
          updatePipelineStep('agentql', 'complete');
          updatePipelineStep('yutori', 'active');
          loadingStatus.textContent = `Yutori: Deep research on ${name}...`;
        } else {
          updatePipelineStep('yutori', 'complete');
          updatePipelineStep('freepik', 'active');
          loadingStatus.textContent = 'Freepik: Generating hero image...';
        }
      }, 2000);
      
      try {
        const res = await fetch(`${API_BASE}/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            company_name: name,
            company_domain: domain || undefined
          })
        });
        
        const data = await res.json();
        
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        updatePipelineStep('freepik', 'complete');
        
        setTimeout(() => {
          displayResults(data);
          loadSavedResults(); // Refresh saved results
        }, 500);
        
      } catch (e) {
        clearInterval(progressInterval);
        alert('Research failed: ' + e.message);
        showState('initial');
      } finally {
        submitBtn.disabled = false;
      }
    }

    // Update pipeline step visual
    function updatePipelineStep(step, status) {
      const el = document.getElementById(`step-${step}`);
      el.classList.remove('bg-gray-700', 'bg-orange-600', 'bg-green-600', 'ring-2', 'ring-orange-400');
      
      if (status === 'active') {
        el.classList.add('bg-orange-600', 'ring-2', 'ring-orange-400');
      } else if (status === 'complete') {
        el.classList.add('bg-green-600');
      } else {
        el.classList.add('bg-gray-700');
      }
    }

    // Reset pipeline
    function resetPipeline() {
      pipelineSteps.forEach(step => updatePipelineStep(step, 'idle'));
      progressBar.style.width = '0%';
    }

    // Show state
    function showState(state) {
      initialState.classList.add('hidden');
      loadingState.classList.add('hidden');
      resultsState.classList.add('hidden');
      
      if (state === 'initial') initialState.classList.remove('hidden');
      if (state === 'loading') loadingState.classList.remove('hidden');
      if (state === 'results') resultsState.classList.remove('hidden');
    }

    // Display results
    function displayResults(data) {
      showState('results');
      
      const brief = data.data;
      const meta = data.meta || {};
      
      resultsState.innerHTML = `
        <div class="fade-in">
          <!-- Header -->
          <div class="flex items-start justify-between mb-6">
            <div>
              <div class="flex items-center gap-2 mb-1">
                <span class="text-2xl">ğŸ¢</span>
                <h2 class="text-2xl font-bold text-white">${brief.company?.name || data.target}</h2>
              </div>
              <p class="text-gray-400">${brief.company?.domain || ''}</p>
            </div>
            <div class="text-right text-sm text-gray-500">
              <div>${meta.duration_seconds ? meta.duration_seconds.toFixed(0) + 's' : ''}</div>
            </div>
          </div>
          
          <!-- Company Summary -->
          <div class="bg-gray-700 rounded-lg p-4 mb-6">
            <h3 class="text-sm font-semibold text-gray-400 uppercase mb-2">Company Summary</h3>
            <p class="text-white">${brief.company?.summary || 'N/A'}</p>
            <div class="flex gap-4 mt-3 text-sm">
              <span class="px-2 py-1 bg-gray-600 rounded">${brief.company?.industry || 'Tech'}</span>
              <span class="px-2 py-1 bg-gray-600 rounded">${brief.company?.stage || 'Startup'}</span>
            </div>
          </div>
          
          <!-- Pain Points & Hooks -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-700 rounded-lg p-4">
              <h3 class="text-sm font-semibold text-red-400 uppercase mb-3">ğŸ¯ Insurance Pain Points</h3>
              <ul class="space-y-2">
                ${(brief.pain_points || []).map(p => `
                  <li class="text-sm text-gray-300 flex items-start gap-2">
                    <span class="text-red-400 mt-1">â€¢</span>
                    <span>${p}</span>
                  </li>
                `).join('')}
              </ul>
            </div>
            <div class="bg-gray-700 rounded-lg p-4">
              <h3 class="text-sm font-semibold text-green-400 uppercase mb-3">ğŸ£ Corgi AI Hooks</h3>
              <ul class="space-y-2">
                ${(brief.hooks || []).map(h => `
                  <li class="text-sm text-gray-300 flex items-start gap-2">
                    <span class="text-green-400 mt-1">â€¢</span>
                    <span>${h}</span>
                  </li>
                `).join('')}
              </ul>
            </div>
          </div>
          
          <!-- Outreach -->
          <div class="bg-gray-700 rounded-lg p-4 mb-6">
            <h3 class="text-sm font-semibold text-orange-400 uppercase mb-3">ğŸ“§ Sales Outreach</h3>
            
            ${brief.outreach ? `
              <div class="mb-4">
                <div class="text-xs text-gray-500 uppercase mb-1">Email Subject</div>
                <div class="text-white font-medium">${brief.outreach.email_subject || ''}</div>
              </div>
              
              <div class="mb-4">
                <div class="text-xs text-gray-500 uppercase mb-1">Cold Email</div>
                <div class="text-gray-300 text-sm whitespace-pre-wrap bg-gray-800 p-3 rounded">${brief.outreach.email_body || ''}</div>
              </div>
              
              <div>
                <div class="text-xs text-gray-500 uppercase mb-1">LinkedIn DM</div>
                <div class="text-gray-300 text-sm bg-gray-800 p-3 rounded">${brief.outreach.linkedin_dm || ''}</div>
              </div>
            ` : '<p class="text-gray-500">No outreach data</p>'}
          </div>
          
          <!-- Hero Image -->
          ${brief.hero_image ? `
            <div class="bg-gray-700 rounded-lg p-4 mb-6">
              <h3 class="text-sm font-semibold text-purple-400 uppercase mb-3">ğŸ¨ Hero Image</h3>
              <img src="${brief.hero_image.dataUri || API_BASE + brief.hero_image.path}" 
                   alt="Hero image" class="w-full rounded-lg max-h-64 object-cover">
            </div>
          ` : ''}
          
          <!-- Sources -->
          ${brief.sources && brief.sources.length > 0 ? `
            <div class="text-sm text-gray-500">
              <span class="font-semibold">Sources:</span>
              ${brief.sources.map(s => `<a href="${s}" target="_blank" class="text-blue-400 hover:underline ml-2">${new URL(s).hostname}</a>`).join('')}
            </div>
          ` : ''}
          
          <!-- Meta -->
          <div class="mt-6 pt-4 border-t border-gray-700 flex gap-4 text-xs text-gray-500">
            <span>AgentQL: ${meta.agentql_used ? 'âœ“' : 'âœ—'}</span>
            <span>Yutori: ${meta.yutori_used ? 'âœ“' : 'âœ—'}</span>
            <span>Freepik: ${meta.freepik_used ? 'âœ“' : 'âœ—'}</span>
          </div>
        </div>
      `;
    }

    // Initialize app
    init();
  </script>
</body>
</html>
